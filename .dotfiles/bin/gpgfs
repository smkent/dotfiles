#!/usr/bin/env python

from __future__ import print_function

import argparse
import os
import subprocess
import sys

if os.getuid() != 0:
    sys.exit(subprocess.call(['sudo'] + sys.argv))

description = 'Mount or unmount a filesystem containing private GnuPG key(s)'
ap = argparse.ArgumentParser(description=description)
# Actions
ap.add_argument('-m', '--mount', metavar='device/path',
                help='Mount the specified encrypted filesystem')
ap.add_argument('-u', '--unmount', action='store_true',
                help='Unmount an already-mounted filesystem')
# Options
default_mountpoint = os.path.join(os.path.expanduser('~'), '.gnupg', 'enc')
ap.add_argument('-d', '--mountpoint', metavar='dir',
                help=('Mount point directory (default: {} or autodetect for '
                      'unmount)'.format(default_mountpoint)))
ap.add_argument('-g', '--gnupg-subdirectory', metavar='dir', default='gnupg',
                help=('GnuPG subdirectory path within the encrypted '
                      'filesystem (default: gnupg)'))
ap.add_argument('-M', '--mapper', metavar='name', default='enc',
                help='cryptsetup mapper name (default: enc)')
ap.add_argument('-n', '--no-list-keys', dest='list_keys', action='store_false',
                help=('Don\'t create GnuPG subdirectory or list GnuPG keyring '
                      'contents after mount'))
args = ap.parse_args()
args.mapper = '/dev/mapper/{}'.format(args.mapper)

if sum(bool(i) for i in [args.mount, args.unmount]) > 1:
    print('Error: Multiple actions specified', file=sys.stderr)
    sys.exit(1)


def unmount():
    if os.path.isdir(args.mountpoint):
        print('Stopping any running agents')
        subprocess.call(['killall', 'gpg-agent', 'dirmngr'])
        if os.path.ismount(args.mountpoint):
            print('Unmounting filesystem from {}'.format(args.mountpoint))
            subprocess.check_call(['umount', args.mountpoint])
        print('Removing directory {}'.format(args.mountpoint))
        subprocess.check_call(['rmdir', args.mountpoint])
    if os.path.exists(args.mapper):
        print('Closing LUKS device {}'.format(args.mapper))
        subprocess.check_call(['cryptsetup', 'luksClose', args.mapper])


def mount():
    if os.path.isdir(args.mountpoint):
        print('Error: {} already exists'.format(args.mountpoint),
              file=sys.stderr)
        sys.exit(1)
    os.mkdir(args.mountpoint, 0o0700)
    print('Created directory {}'.format(args.mountpoint))
    subprocess.check_call(['cryptsetup', 'luksOpen', args.mount,
                           args.mapper.replace('/dev/mapper/', '', 1)])
    print('Created LUKS device {}'.format(args.mapper))
    subprocess.check_call(['mount', args.mapper, args.mountpoint])
    print('Mounted filesystem on {}'.format(args.mountpoint))
    priv_homedir = os.path.join(args.mountpoint, args.gnupg_subdirectory)
    if not args.list_keys:
        print('Skipping GnuPG home directory list: {}'.format(priv_homedir))
        sys.exit(0)
    # Perform GnuPG-specific actions as the invoking user
    sudo_uid = os.environ.get('SUDO_UID')
    if sudo_uid:
        os.setuid(int(sudo_uid))
    if not os.path.isdir(priv_homedir):
        os.mkdir(priv_homedir)
    subprocess.check_call(['chmod', '-Rc', 'go-rwx', priv_homedir])
    print('GnuPG home directory: {}'.format(priv_homedir))
    subprocess.check_call(['gpg', '--homedir', priv_homedir, '-k'])
    sys.exit(0)


if args.mount:
    if not args.mountpoint:
        args.mountpoint = default_mountpoint
    if not os.path.exists(args.mount):
        print('Error: {} does not exist'.format(args.mount), file=sys.stderr)
        sys.exit(1)
    unmount()
    mount()
elif args.unmount:
    if not args.mountpoint:
        try:
            cmd = ['findmnt', '-nr', '-o', 'target', '-S', args.mapper]
            mountpoint = subprocess.check_output(cmd).strip()
            if mountpoint and os.path.exists(mountpoint):
                args.mountpoint = mountpoint
            else:
                args.mountpoint = default_mountpoint
        except subprocess.CalledProcessError:
            args.mountpoint = default_mountpoint
    unmount()
else:
    print('Error: No action specified', file=sys.stderr)

#!/usr/bin/env python3

import argparse
import os
import subprocess
import sys
from contextlib import suppress
from enum import Enum
from functools import cached_property
from pathlib import Path

PROGRAM_NAME = Path(__file__).stem


class CLIError(Exception):
    pass


class CLIColors(Enum):
    RESET = "\033[0m"
    BOLD = "\033[1m"
    YELLOW = "\033[33m"


class Dotfiles:
    def __call__(self) -> None:
        try:
            self.args.command_func()
        except CLIError as e:
            print(f"Error: {e}", file=sys.stderr)
            sys.exit(1)

    def config(self) -> None:
        config_dir = Path().home() / ".dotfiles" / ".data"
        rc_conf = config_dir / "config-rc"
        if not self.args.overwrite and rc_conf.exists():
            raise CLIError(f"Configuration exists in {rc_conf}")

        def _config_username() -> None:
            username = self._prompt("Username", default=os.environ.get("USER"))
            if not username:
                return
            config_dir.mkdir(exist_ok=True, parents=True)
            rc_content = [f'prompt_hide_user="{username}"'] + [
                line
                for line in (
                    rc_conf.read_text().splitlines() if rc_conf.exists else []
                )
                if not line.startswith("prompt_hide_user=")
            ]
            rc_conf.write_text(os.linesep.join(rc_content) + os.linesep)

        def _config_git_email() -> None:
            conf = Path().home() / ".local" / "gitconfig"
            git_email = ""
            with suppress(subprocess.CalledProcessError):
                git_email = subprocess.check_output(
                    ["git", "config", "--get", "user.email"], text=True
                ).strip()
            email = self._prompt("Email", default=git_email, required=True)
            cmd = ["git", "config", "--file", str(conf), "user.email", email]
            subprocess.run(cmd)

        _config_username()
        _config_git_email()

    def _prompt(
        self, prompt: str, default: str = "", required: bool = False
    ) -> str:
        if default:
            prompt += (
                f" [{CLIColors.BOLD.value}{default}{CLIColors.RESET.value}]"
            )
        while True:
            try:
                value = input(f"{prompt}: ").strip() or default
            except EOFError:
                value = default
                print("")
            if required and not value:
                print(
                    f"{CLIColors.YELLOW.value}"
                    f"Error: {prompt} is required"
                    f"{CLIColors.RESET.value}",
                    flush=True,
                )
                continue
            return value

    @cached_property
    def args(self) -> argparse.Namespace:
        ap = argparse.ArgumentParser(description="Dotfiles helpers")
        subp = ap.add_subparsers(title="Commands", metavar="command")
        config_p = subp.add_parser("config", help="Configure dotfiles")
        config_p.set_defaults(command_func=self.config)
        config_p.add_argument(
            "-y",
            "--overwrite",
            action="store_true",
            help="Overwrite existing configuration",
        )
        args = ap.parse_args()
        if not getattr(args, "command_func", None):
            ap.print_help()
            sys.exit(0)
        return args


if __name__ == "__main__":
    Dotfiles()()
